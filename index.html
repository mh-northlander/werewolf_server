<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <title>websocket-chat</title>
    <link rel="stylesheet"
          href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script type="text/javascript"
            src="/socket.io/socket.io.js"></script>
  </head>

  <body>
    <div class="container">
      <h1>WebSocket-Chat</h1>
      <form class="form-inline">
        <div class="form-group">
          <label for="msgForm"> message: </label>
          <input type="text" class="form-control" id="msgForm">
        </div>
        <button type="submit" class="btn btn-primary">join room</button>
      </form>
      <form class="form-inline">
        <button type="button" class="btn btn-primary" id="gameStart">gameStart</button>
        <button type="button" class="btn btn-primary" id="phaseShift">phaseShift</button>
        <button type="button" class="btn btn-primary" id="ackTest">ack test</button>
      </form>
      <div id="chatLogs"></div>
    </div>

    <script type="text/javascript">
      function randomString(length) {
        return Math.round((Math.pow(36, length + 1) - Math.random() * Math.pow(36, length))).toString(36).slice(1);
      };
      var userId = randomString(8)
      var socket = io.connect();

      socket.on("joinRoom", function(data){
        appendMsg(data.value)
      });
      socket.on("startGame", function(data){
        appendMsg("あなたは" + data.value + "です。");
      });

      function appendMsg(text) {
        $("#chatLogs").append("<div>" + text + "</div>");
      }

      $("form").submit(function(e){
        var message = $("#msgForm").val();
        $("#msgForm").val('');
        socket.emit("joinRoom", {userId : userId, name: message});
        e.preventDefault();
      });

      $("#gameStart").click(function(e){
        socket.emit("startGame");
      });

      // test
      socket.on("phaseShiftTest", function(data){
        appendMsg("phase:" + data.name);
      })
      $("#phaseShift").click(function(e){
        socket.emit("phaseShiftTest");
      });
      $("#ackTest").click(function(e){
        socket.emit("ackTest1");
      });
      socket.on("ackTest2", function(fn){
        appendMsg("acktest")
        fn("yatta!");
      })

    </script>
  </body>
</html>
